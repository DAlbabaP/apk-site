// –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—Å–∫–æ–π –ø–∞–Ω–µ–ª—å—é
class AdminDashboard {
    constructor() {
        this.currentUser = null;
        this.users = [];
        this.requests = [];
        this.managers = [];
        this.currentEditUser = null;
        this.currentAssignRequest = null;
        this.init();
    }

    async init() {
        this.checkAuth();
        await this.loadData();
        this.updateStats();
        this.initNavigation();
        this.initFilters();
        this.renderDashboard();
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    checkAuth() {
        try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (!AuthManager.isAuthenticated()) {
                console.log('‚ùå User not authenticated, redirecting to login');
                window.location.href = 'login.html';
                return;
            }

            const user = AuthManager.getCurrentUser();
            if (!user) {
                console.log('‚ùå No user data found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }

            if (user.role !== 'admin') {
                console.log('‚ùå User is not admin, redirecting to appropriate dashboard');
                const dashboards = {
                    'user': 'dashboard-user.html',
                    'manager': 'dashboard-manager.html'
                };
                if (dashboards[user.role]) {
                    window.location.href = dashboards[user.role];
                }
                return;
            }

            console.log('‚úÖ Admin user authenticated:', user.username);
            this.currentUser = user;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —à–∞–ø–∫–µ
            document.getElementById('userName').textContent = user.full_name || user.username || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
            document.getElementById('userRole').textContent = '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
            document.getElementById('userAvatar').textContent = (user.full_name || user.username || '–ê').charAt(0).toUpperCase();
        } catch (error) {
            console.error('‚ùå Auth check error:', error);
            window.location.href = 'login.html';
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async loadData() {
        try {
            console.log('üîÑ Loading admin data from API...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const usersResponse = await UsersAPI.getAll();
            this.users = usersResponse.users || [];
            console.log('‚úÖ Users loaded:', this.users.length);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞—è–≤–∫–∏
            const applicationsResponse = await ApplicationsAPI.getAll();
            this.requests = applicationsResponse.applications || [];
            console.log('‚úÖ Applications loaded:', this.requests.length);
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
            this.managers = this.users.filter(user => user.role === 'manager');
            console.log('‚úÖ Managers found:', this.managers.length);
        } catch (error) {
            console.error('‚ùå Failed to load data:', error);
            this.users = [];
            this.requests = [];
            this.managers = [];
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async updateStats() {
        try {
            console.log('üîÑ Loading admin statistics...');
            const statsResponse = await StatsAPI.getAdminStats();
            const stats = statsResponse.stats;
            
            document.getElementById('totalUsers').textContent = stats.total_users || 0;
            document.getElementById('totalRequests').textContent = stats.total_applications || 0;
            document.getElementById('pendingRequests').textContent = stats.pending_applications || 0;
            document.getElementById('completedRequests').textContent = stats.completed_applications || 0;
            
            console.log('‚úÖ Admin statistics updated');
        } catch (error) {
            console.error('‚ùå Failed to load statistics:', error);
            // Fallback –∫ –ª–æ–∫–∞–ª—å–Ω—ã–º –ø–æ–¥—Å—á–µ—Ç–∞–º
            const totalUsers = this.users.length;
            const totalRequests = this.requests.length;
            const pendingRequests = this.requests.filter(req => 
                ['new', 'pending'].includes(req.status)
            ).length;
            const completedRequests = this.requests.filter(req => 
                req.status === 'completed'
            ).length;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalRequests').textContent = totalRequests;
            document.getElementById('pendingRequests').textContent = pendingRequests;
            document.getElementById('completedRequests').textContent = completedRequests;
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    initNavigation() {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.getAttribute('data-page');
                if (page) {
                    this.showPage(page);
                }
            });
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    initFilters() {
        // –§–∏–ª—å—Ç—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        ['userRoleFilter', 'userStatusFilter'].forEach(filterId => {
            const element = document.getElementById(filterId);
            if (element) {
                element.addEventListener('change', () => {
                    this.renderUsers();
                });
            }
        });

        // –§–∏–ª—å—Ç—Ä—ã –∑–∞—è–≤–æ–∫
        ['requestStatusFilter', 'requestPriorityFilter', 'requestAssignmentFilter'].forEach(filterId => {
            const element = document.getElementById(filterId);
            if (element) {
                element.addEventListener('change', () => {
                    this.renderRequests();
                });
            }
        });
    }

    // –ü–æ–∫–∞–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    showPage(pageId) {
        document.querySelectorAll('.page-section').forEach(section => {
            section.classList.remove('active');
        });

        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.add('active');
        }

        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });

        const activeLink = document.querySelector(`[data-page="${pageId}"]`);
        if (activeLink && activeLink.classList.contains('nav-link')) {
            activeLink.classList.add('active');
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        switch (pageId) {
            case 'users':
                this.renderUsers();
                break;
            case 'requests':
                this.renderRequests();
                break;
            case 'assignments':
                this.renderAssignments();
                break;
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞
    renderDashboard() {
        const container = document.getElementById('recentActivity');
        if (!container) return;
        
        const recentRequests = this.requests
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
            .slice(0, 10);

        if (recentRequests.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="icon">üìã</div>
                    <h4>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h4>
                    <p>–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                </div>
            `;
        } else {
            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–ó–∞—è–≤–∫–∞</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–∞—Ç–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentRequests.map(req => {
                            const user = this.users.find(u => u.id == req.user_id);
                            return `
                                <tr>
                                    <td><strong>${req.title}</strong></td>
                                    <td>${user ? (user.full_name || user.first_name + ' ' + user.last_name || user.username) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                                    <td><span class="status-badge status-${req.status}">${this.getStatusName(req.status)}</span></td>
                                    <td>${new Date(req.created_at).toLocaleDateString('ru-RU')}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    renderUsers() {
        const container = document.getElementById('usersContainer');
        if (!container) return;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        let filteredUsers = [...this.users];
        
        const roleFilter = document.getElementById('userRoleFilter')?.value;
        if (roleFilter) {
            filteredUsers = filteredUsers.filter(user => user.role === roleFilter);
        }

        const statusFilter = document.getElementById('userStatusFilter')?.value;
        if (statusFilter) {
            filteredUsers = filteredUsers.filter(user => user.status === statusFilter);
        }

        if (filteredUsers.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="icon">üë•</div>
                    <h4>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h4>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</p>
                </div>
            `;
        } else {
            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–§–ò–û</th>
                            <th>–õ–æ–≥–∏–Ω</th>
                            <th>Email</th>
                            <th>–†–æ–ª—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredUsers.map(user => `
                            <tr>
                                <td><strong>${user.full_name || (user.first_name + ' ' + user.last_name) || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</strong></td>
                                <td>${user.username}</td>
                                <td>${user.email}</td>
                                <td><span class="role-badge role-${user.role}">${this.getRoleName(user.role)}</span></td>
                                <td><span class="status-badge status-${user.status}">${this.getStatusName(user.status)}</span></td>
                                <td>${new Date(user.created_at).toLocaleDateString('ru-RU')}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="adminDashboard.editUser('${user.id}')">
                                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                    ${user.role !== 'admin' ? `
                                        <button class="btn btn-sm btn-danger" onclick="adminDashboard.toggleUserStatus('${user.id}')">
                                            ${user.status === 'active' ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}
                                        </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫
    renderRequests() {
        const container = document.getElementById('requestsContainer');
        if (!container) return;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        let filteredRequests = [...this.requests];
        
        const statusFilter = document.getElementById('requestStatusFilter')?.value;
        if (statusFilter) {
            filteredRequests = filteredRequests.filter(req => req.status === statusFilter);
        }

        const priorityFilter = document.getElementById('requestPriorityFilter')?.value;
        if (priorityFilter) {
            filteredRequests = filteredRequests.filter(req => req.priority === priorityFilter);
        }

        const assignmentFilter = document.getElementById('requestAssignmentFilter')?.value;
        if (assignmentFilter === 'unassigned') {
            filteredRequests = filteredRequests.filter(req => !req.assigned_manager_id);
        } else if (assignmentFilter === 'assigned') {
            filteredRequests = filteredRequests.filter(req => req.assigned_manager_id);
        }

        if (filteredRequests.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="icon">üìã</div>
                    <h4>–ó–∞—è–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h4>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</p>
                </div>
            `;
        } else {
            const sortedRequests = filteredRequests.sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
            );

            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–ó–∞—è–≤–∫–∞</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                            <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedRequests.map(req => {
                            const user = this.users.find(u => u.id == req.user_id);
                            const manager = this.users.find(u => u.id == req.assigned_manager_id);
                            return `
                                <tr>
                                    <td><strong>${req.title}</strong></td>
                                    <td>${user ? (user.full_name || user.first_name + ' ' + user.last_name || user.username) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                                    <td>${manager ? (manager.full_name || manager.first_name + ' ' + manager.last_name || manager.username) : '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</td>
                                    <td><span class="role-badge role-${req.priority === 'high' ? 'admin' : req.priority === 'medium' ? 'manager' : 'user'}">${this.getPriorityName(req.priority)}</span></td>
                                    <td><span class="status-badge status-${req.status}">${this.getStatusName(req.status)}</span></td>
                                    <td>${new Date(req.created_at).toLocaleDateString('ru-RU')}</td>
                                    <td>
                                        ${!req.assigned_manager_id ? `
                                            <button class="btn btn-sm btn-primary" onclick="adminDashboard.openAssignModal('${req.id}')">
                                                –ù–∞–∑–Ω–∞—á–∏—Ç—å
                                            </button>
                                        ` : `
                                            <button class="btn btn-sm btn-secondary" onclick="adminDashboard.openAssignModal('${req.id}')">
                                                –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∏—Ç—å
                                            </button>
                                        `}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π
    renderAssignments() {
        const container = document.getElementById('assignmentsContainer');
        if (!container) return;
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞—è–≤–∫–∏ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
        const assignmentData = this.managers.map(manager => {
            const assignedRequests = this.requests.filter(req => req.assigned_manager_id == manager.id);
            return {
                manager,
                total: assignedRequests.length,
                pending: assignedRequests.filter(req => ['new', 'pending'].includes(req.status)).length,
                completed: assignedRequests.filter(req => req.status === 'completed').length,
                requests: assignedRequests
            };
        });

        const unassignedRequests = this.requests.filter(req => !req.assigned_manager_id);

        container.innerHTML = `
            ${unassignedRequests.length > 0 ? `
                <div style="background: var(--warning-color); color: var(--white); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 2rem;">
                    <h4>‚ö†Ô∏è –ù–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫: ${unassignedRequests.length}</h4>
                    <p>–¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</p>
                </div>
            ` : ''}
            
            <div class="stats-grid">
                ${assignmentData.map(data => `
                    <div class="stat-card">
                        <h3>${data.manager.full_name || data.manager.first_name + ' ' + data.manager.last_name || data.manager.username}</h3>
                        <div class="stat-number">${data.total}</div>
                        <p>–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</p>
                        <div class="assignment-details">
                            <small>–í —Ä–∞–±–æ—Ç–µ: ${data.pending} | –ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${data.completed}</small>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    getRoleName(role) {
        const roleNames = {
            'admin': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
            'manager': '–ú–µ–Ω–µ–¥–∂–µ—Ä',
            'user': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
        };
        return roleNames[role] || role;
    }

    getStatusName(status) {
        const statusNames = {
            'active': '–ê–∫—Ç–∏–≤–Ω—ã–π',
            'inactive': '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π',
            'pending': '–û–∂–∏–¥–∞–Ω–∏–µ',
            'in_progress': '–í —Ä–∞–±–æ—Ç–µ',
            'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
            'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ'
        };
        return statusNames[status] || status;
    }

    getPriorityName(priority) {
        const priorityNames = {
            'low': '–ù–∏–∑–∫–∏–π',
            'medium': '–°—Ä–µ–¥–Ω–∏–π',
            'high': '–í—ã—Å–æ–∫–∏–π',
            'urgent': '–°—Ä–æ—á–Ω—ã–π'
        };
        return priorityNames[priority] || priority;
    }

    // –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –º–µ—Ç–æ–¥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∏–∑ HTML
    editUser(userId) {
        console.log('Edit user:', userId);
        // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    }

    toggleUserStatus(userId) {
        console.log('Toggle user status:', userId);
        // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    }

    openAssignModal(requestId) {
        console.log('Open assign modal:', requestId);
        // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
document.addEventListener('DOMContentLoaded', () => {
    console.log('üîß AdminDashboard initializing...');
    
    // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ AuthManager
    if (typeof AuthManager !== 'undefined') {
        console.log('‚úÖ AuthManager ready, starting AdminDashboard');
        window.adminDashboard = new AdminDashboard();
    } else {
        console.log('‚è≥ Waiting for AuthManager...');
        const checkAuth = setInterval(() => {
            if (typeof AuthManager !== 'undefined') {
                console.log('‚úÖ AuthManager ready, starting AdminDashboard');
                clearInterval(checkAuth);
                window.adminDashboard = new AdminDashboard();
            }
        }, 100);
    }
});
